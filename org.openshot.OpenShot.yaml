app-id: org.openshot.OpenShot
default-branch: stable
base: io.qt.qtwebkit.BaseApp
base-version: '5.15'
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: openshot-qt
rename-icon: openshot-qt
finish-args:
  - --require-version=0.11.4 # fixes file saving
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=host
  - --socket=pulseaudio
  - --talk-name=org.freedesktop.Flatpak
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/cmake
  - /share/man
  - '*.a'
  - '*.la'
cleanup-commands: # https://github.com/flatpak/flatpak/issues/1082
  - rm -rf /app/{include,lib/{cmake,mkspecs,pkgconfig}}
modules:

  - name: toml
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b9/19/5cbd78eac8b1783671c40e34bb0fa83133a06d340a38b55c645076d40094/toml-0.10.0.tar.gz
        sha256: 229f81c57791a41d65e399fc06bf0848bab550a9dfd5ed66df18ce5f05e73d5c

  - name: packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/65/37/83e3f492eb52d771e2820e88105f605335553fe10422cba9d256faeb1702/packaging-20.3.tar.gz
        sha256: 3c292b474fda1671ec57d46d739d072bfd495a4f51ad01a055121d81e952b7a3

  - name: pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c1/47/dfc9c342c9842bbe0036c7f763d2d6686bcf5eb1808ba3e170afdb282210/pyparsing-2.4.7.tar.gz
        sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/bc/dd/aa60ae73bc213466fd158e3d8b91d55ac00a248b14a98919bfe0e12c5d74/sip-5.2.0.tar.gz
        sha256: 3d3f279a61d54d832b12496409811ee062dab1ac05a1e7b40824f63b423fb0e7

  - name: PyQt5_sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/32/24/1537d09deb3aee2e5c390cd456420a455ac47ef3f8ac323d8397af1c1c13/PyQt5_sip-12.7.2.tar.gz
        sha256: 16a19b9f36985b8bff30b89fb8859d831713dd528fba5600563e36ff077960a2

  - name: PyQt5
    buildsystem: simple
    build-commands:
      - PYVER=$(python3 -c "import sys;print(sys.version_info[1])") &&
        QMAKEPATH=/app/lib python3 configure.py
        --confirm-license
        --bindir=/app/bin
        --destdir=/app/lib/python3.${PYVER}/site-packages
        --designer-plugindir=/app/lib/plugins/designer
        --qml-plugindir=/app/lib/plugins/PyQt5
        --sipdir=/app/share/sip
        --stubsdir=/app/lib/python3.${PYVER}/site-packages/PyQt5
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/1d/31/896dc3dfb6c81c70164019a6cbba6ab037e3af7653d9ca60ccc874ee4c27/PyQt5-5.15.1.tar.gz
        sha256: d9a76b850246d08da9863189ecb98f6c2aa9b4d97a3e85e29330a264aed0f9a1

  - name: zeromq
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.2/zeromq-4.3.2.tar.gz
        sha256: ebd7b5c830d6428956b67a0454a7f8cbed1de74b3b01e5c33c5378e22740f763

  - name: swig
    config-opts:
      - --without-alllang
      - --with-python=/usr/bin/python3
      - --without-boost
      - --without-pcre
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/swig/swig/swig-3.0.12/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d
        mirror-urls:
          - http://http.debian.net/debian/pool/main/s/swig/swig_3.0.12.orig.tar.gz

  - name: cppzmq
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCPPZMQ_BUILD_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/zeromq/cppzmq/archive/v4.6.0.tar.gz
        sha256: e9203391a0b913576153a2ad22a2dc1479b1ec325beb6c46a3237c669aef5a52

  - name: unittest-cpp
    config-opts:
      - --disable-static
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/unittest-cpp/unittest-cpp/releases/download/v2.0.0/unittest-cpp-2.0.0.tar.gz
        sha256: 1d1b118518dc200e6b87bbf3ae7bfd00a0cfc6be708255f98e5e3d627a7c9f98

  - name: cython
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ee/2a/c4d2cdd19c84c32d978d18e9355d1ba9982a383de87d0fcb5928553d37f4/Cython-0.27.3.tar.gz
        sha256: 6a00512de1f2e3ce66ba35c5420babaef1fe2d9c43a8faab4080b0dbcc26bc64

  - name: pyzmq
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://github.com/zeromq/pyzmq/archive/v16.0.3.tar.gz
        sha256: 680b03afd8acab0c61cab825e4c358cbb25ce05eb922e3044e4408694010dcea

  - name: requests
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/b0/e1/eab4fc3752e3d240468a8c0b284607899d2fbfb236a56b7377a329aa8d09/requests-2.18.4.tar.gz
        sha256: 9c443e7324ba5b85070c4a818ade28bfabedf16ea10206da1132edaa6dda237e

  - name: urllib3
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ee/11/7c59620aceedcc1ef65e156cc5ce5a24ef87be4107c2b74458464e437a5d/urllib3-1.22.tar.gz
        sha256: cc44da8e1145637334317feebd728bd869a35285b93cbb4cca2577da7e62db4f

  - name: chardet
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://pypi.python.org/packages/fc/bb/a5768c230f9ddb03acc9ef3f0d4a3cf93462473795d18e9535498c8f929d/chardet-3.0.4.tar.gz
        sha256: 84ab92ed1c4d4f16916e05906b6b75a6c0fb5db821cc65e70cbd64a3e2a5eaae

  - name: certifi
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/23/3f/8be01c50ed24a4bd6b8da799839066ce0288f66f5e11f0367323467f0cbc/certifi-2017.11.5.tar.gz
        sha256: 5ec74291ca1136b40f0379e1128ff80e866597e4e2c1e755739a913bbc3613c0
  
  - name: idna
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/65/c4/80f97e9c9628f3cac9b98bfca0402ede54e0563b56482e3e6e45c43c4935/idna-2.7.tar.gz
        sha256: 684a38a6f903c1d71d6d5fac066b58d7768af4de2b832e426ec79c30daa94a16

  - name: ImageMagick
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: https://imagemagick.org/download/releases/ImageMagick-7.0.9-27.tar.xz
        sha256: 0589b567dfc14390a81858feabff06b974162690660cc02893cbe9713b59db1c

  - name: resvg
    buildsystem: simple
    build-commands:
      - cargo build --verbose --release --frozen --manifest-path capi/Cargo.toml --features "qt-backend"
      - install -Dm644 target/release/libresvg.so -t /app/lib
      - install -Dm644 capi/include/*.h -t /app/include/resvg
    sources:
      - type: archive
        url: https://github.com/RazrFalcon/resvg/releases/download/v0.9.1/resvg-0.9.1.tar.xz
        sha256: dd00841f0928c7106a6ee1ca761d7a61747d26a27038008a3568398136aa5b16
      - type: shell
        commands:
          - sed -i 's|/usr/local/share/fonts/|/run/host/fonts/|' usvg/src/fontdb.rs
      - type: patch
        path: resvg-qt515.patch

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20190305-2245-stable.tar.bz2
        sha256: be52c96ef8bd930fbc1ecff03abac9b94976b444ea7641345e08e20d9e594d16

  - name: nv-codec-headers
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    cleanup:
      - '*'
    sources:
      - type: git
        url: https://git.videolan.org/git/ffmpeg/nv-codec-headers.git
        commit: 4a0bbfd58724d6d19851cd8a6f7a9098dde9ab77
        tag: n9.1.23.1

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-programs
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libopus
      - --enable-libvpx
      - --enable-avresample
      - --enable-libx264
    cleanup:
      - /share/ffmpeg
    sources:
      - type: archive
        url: https://www.ffmpeg.org/releases/ffmpeg-4.2.2.tar.xz
        sha256: cb754255ab0ee2ea5f66f8850e1bd6ad5cac1cd855d0a2f4990fb8c668b0d29c

  - name: libopenshot-audio
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/OpenShot/libopenshot-audio/archive/v0.2.0.tar.gz
        sha256: 937ff4f1c2dfb8ab5d56ad85beacaa29dfd5a79af0d9cf647386034fe9882309

  - name: libopenshot
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DLIBOPENSHOT_AUDIO_BASE_DIR=/app/include/libopenshot-audio
      - -DUNITTEST++_INCLUDE_DIR=/app/include/UnitTest++
      - -DENABLE_RUBY=0
      - -DRESVG_INCLUDE_DIR=/app/include/resvg
    sources:
      - type: archive
        url: https://github.com/OpenShot/libopenshot/archive/v0.2.5.tar.gz
        sha256: 8ae7d226fbd2efbc84da4f7d9d8c7f3cc9616e4de46e1233e3b0a84ac0a429bc
      - type: patch
        path: libopenshot-gcc10.patch

  - name: openshot-qt
    buildsystem: simple
    build-commands:
      - find . -type f -exec sed -i 's/Bitstream Vera Sans/DejaVu Sans/g' {} +
      - python3 setup.py install --prefix=/app --root=/
      - install -D inkscape.sh /app/bin/inkscape
      - install -D blender.sh /app/bin/blender
    sources:
      - type: script
        dest-filename: inkscape.sh
        commands:
          - flatpak-spawn --host flatpak info org.inkscape.Inkscape >/dev/null 2>/dev/null &&
            exec flatpak-spawn --host flatpak run org.inkscape.Inkscape "$@" ||
            exec flatpak-spawn --host flatpak run --command=zenity $FLATPAK_ID --error --text="Inkscape not installed!"
      - type: script
        dest-filename: blender.sh
        commands:
          - INPUT_FILE="$(awk -F "=" '/app-path/ {print $2}' /.flatpak-info)${2:4}" &&
            exec flatpak-spawn --host
            flatpak run --filesystem=~/.local/share/flatpak --filesystem=/var/lib/flatpak org.blender.Blender -b ${INPUT_FILE} -P "$4"
      - type: archive
        url: https://github.com/OpenShot/openshot-qt/archive/v2.5.1.tar.gz
        sha256: 4c25eb9a5de42e749de4c6ca2f7a313c60e1283fe52d70c121629dbb8bb2df7b
      - type: shell
        commands: # add to <provides>
          - sed -i '35i <id>openshot-qt</id>' xdg/org.openshot.OpenShot.appdata.xml
