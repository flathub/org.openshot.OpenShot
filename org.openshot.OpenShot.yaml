app-id: org.openshot.OpenShot
branch: stable
base: io.qt.qtwebkit.BaseApp
base-version: '5.12'
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: openshot-qt
rename-icon: openshot-qt
finish-args:
  - --require-version=0.11.4 # fixes file saving
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=host
  - --socket=pulseaudio
  - --env=PYTHONPATH=/app/lib/python3/dist-packages
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/cmake
  - /share/man
  - '*.a'
  - '*.la'
cleanup-commands: # https://github.com/flatpak/flatpak/issues/1082
  - rm -rf /app/{include,lib/{cmake,mkspecs,pkgconfig}}
modules:

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 configure.py
        --bindir=/app/bin
        --destdir=/app/lib/python3/dist-packages
        --incdir=/app/include/python3
        --sipdir=/app/share/sip
        --stubsdir=/app/lib/python3/dist-packages
        --sip-module=PyQt5.sip
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.21/sip-4.19.21.tar.gz
        sha256: 6af9979ab41590e8311b8cc94356718429ef96ba0e3592bdd630da01211200ae
  
  - name: pyqt
    buildsystem: simple
    build-commands:
      - QMAKEPATH=/app/lib python3 configure.py
        --confirm-license
        --sip-incdir=/app/include/python3
        --bindir=/app/bin
        --destdir=/app/lib/python3/dist-packages
        --designer-plugindir=/app/lib/plugins/designer
        --qml-plugindir=/app/lib/plugins/PyQt5
        --sipdir=/app/share/sip
        --stubsdir=/app/lib/python3/dist-packages/PyQt5
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.riverbankcomputing.com/static/Downloads/PyQt5/5.12.3/PyQt5_gpl-5.12.3.tar.gz
        sha256: 0db0fa37debab147450f9e052286f7a530404e2aaddc438e97a7dcdf56292110

  - name: zeromq
    config-opts:
      - --disable-static
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.2.3/zeromq-4.2.3.tar.gz
        sha256: 8f1e2b2aade4dbfde98d82366d61baef2f62e812530160d2e6d0a5bb24e40bc0

  - name: swig
    config-opts:
      - --without-alllang
      - --with-python=/usr/bin/python3
      - --without-boost
      - --without-pcre
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/swig/swig/swig-3.0.12/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d
        mirror-urls:
          - http://http.debian.net/debian/pool/main/s/swig/swig_3.0.12.orig.tar.gz

  - name: cppzmq
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    sources:
      - type: archive
        url: https://github.com/zeromq/cppzmq/archive/v4.2.3.tar.gz
        sha256: 3e6b57bf49115f4ae893b1ff7848ead7267013087dc7be1ab27636a97144d373

  - name: unittest-cpp
    config-opts:
      - --disable-static
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/unittest-cpp/unittest-cpp/releases/download/v2.0.0/unittest-cpp-2.0.0.tar.gz
        sha256: 1d1b118518dc200e6b87bbf3ae7bfd00a0cfc6be708255f98e5e3d627a7c9f98

  - name: cython
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ee/2a/c4d2cdd19c84c32d978d18e9355d1ba9982a383de87d0fcb5928553d37f4/Cython-0.27.3.tar.gz
        sha256: 6a00512de1f2e3ce66ba35c5420babaef1fe2d9c43a8faab4080b0dbcc26bc64

  - name: pyzmq
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://github.com/zeromq/pyzmq/archive/v16.0.3.tar.gz
        sha256: 680b03afd8acab0c61cab825e4c358cbb25ce05eb922e3044e4408694010dcea

  - name: requests
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/b0/e1/eab4fc3752e3d240468a8c0b284607899d2fbfb236a56b7377a329aa8d09/requests-2.18.4.tar.gz
        sha256: 9c443e7324ba5b85070c4a818ade28bfabedf16ea10206da1132edaa6dda237e

  - name: urllib3
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ee/11/7c59620aceedcc1ef65e156cc5ce5a24ef87be4107c2b74458464e437a5d/urllib3-1.22.tar.gz
        sha256: cc44da8e1145637334317feebd728bd869a35285b93cbb4cca2577da7e62db4f

  - name: chardet
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://pypi.python.org/packages/fc/bb/a5768c230f9ddb03acc9ef3f0d4a3cf93462473795d18e9535498c8f929d/chardet-3.0.4.tar.gz
        sha256: 84ab92ed1c4d4f16916e05906b6b75a6c0fb5db821cc65e70cbd64a3e2a5eaae

  - name: certifi
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://pypi.python.org/packages/23/3f/8be01c50ed24a4bd6b8da799839066ce0288f66f5e11f0367323467f0cbc/certifi-2017.11.5.tar.gz
        sha256: 5ec74291ca1136b40f0379e1128ff80e866597e4e2c1e755739a913bbc3613c0
  
  - name: idna
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/65/c4/80f97e9c9628f3cac9b98bfca0402ede54e0563b56482e3e6e45c43c4935/idna-2.7.tar.gz
        sha256: 684a38a6f903c1d71d6d5fac066b58d7768af4de2b832e426ec79c30daa94a16

  - name: ImageMagick6
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick6/archive/6.9.10-21.tar.gz
        sha256: 49307c8d1f847adb0e0e2ec2ce48a8d57e5eb9bf224ad630a8fa21afe49c233d

  - name: resvg
    buildsystem: simple
    build-commands:
      - cargo build --verbose --release --frozen --manifest-path capi/Cargo.toml --features "qt-backend"
      - install -Dm644 target/release/libresvg.so -t /app/lib
      - install -Dm644 capi/include/*.h -t /app/include/resvg
    sources:
      - type: archive
        url: https://github.com/RazrFalcon/resvg/releases/download/v0.9.0/resvg-0.9.0.tar.xz
        sha256: 669ac4fa4e63b8540f1a8c849f747db25bf870c07ccf0830de4f24209d0e017e

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20180807-2245-stable.tar.bz2
        sha256: 1439f1a054c87965089b646e77d16e1a8bf2f9687e4dd696ac518e44c7644c2a

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-programs
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libopus
      - --enable-libvpx
      - --enable-avresample
      - --enable-libx264
    cleanup:
      - /share/ffmpeg
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.0.3.tar.xz
        sha256: 253c37e3f1d3626a2566e496554de9a4c29050753660835909a466d66b12e2ed

  - name: libopenshot-audio
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/OpenShot/libopenshot-audio/archive/v0.1.9.tar.gz
        sha256: 818708988758a6bdf625472f6b420c42cca2df73362ef0566006cf7af983da96

  - name: libopenshot
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DLIBOPENSHOT_AUDIO_BASE_DIR=/app/include/libopenshot-audio
      - -DUNITTEST++_INCLUDE_DIR=/app/include/UnitTest++
      - -DENABLE_RUBY=0
      - -DRESVG_INCLUDE_DIR=/app/include/resvg
    sources:
      - type: archive
        url: https://github.com/OpenShot/libopenshot/archive/v0.2.4.tar.gz
        sha256: 173a33b90c03066025ecd0272fd2d4e3beec63cc51a05b858fa8672186ac7545
      - type: shell
        commands:
          - sed -i 's|${_REL_PYTHON_MODULE_PATH}|lib/python3/dist-packages|g' src/bindings/python/CMakeLists.txt

  - name: openshot-qt
    buildsystem: simple
    build-commands:
      - PYTHONPATH=/app/lib/python3/dist-packages python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://github.com/OpenShot/openshot-qt/archive/v2.5.0.tar.gz
        sha256: b48d2d924d9124a61d5053b2c04b2f083f16fd86395f0e0f231082d34ff0521f
  
